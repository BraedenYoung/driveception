<link rel="import" href="../bower_components/polymer/polymer.html">

<link rel="import" href="../bower_components/core-scaffold/core-scaffold.html">
<link rel="import" href="../bower_components/core-header-panel/core-header-panel.html">
<link rel="import" href="../bower_components/core-menu/core-menu.html">
<link rel="import" href="../bower_components/core-item/core-item.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/core-icon-button/core-icon-button.html">
<link rel="import" href="../bower_components/core-toolbar/core-toolbar.html">
<link rel="import" href="../bower_components/core-menu/core-submenu.html">
<link rel="import" href="../bower_components/core-animated-pages/core-animated-pages.html">
<link rel="import" href="../bower_components/core-animated-pages/transitions/slide-from-right.html">
<link rel="import" href="../bower_components/flatiron-director/flatiron-director.html">
<link rel="import" href="../bower_components/font-roboto/roboto.html">
<!--Icon sets-->
<link rel="import" href="../bower_components/core-icons/core-icons.html">
<!--Custom elements-->
<link rel="import" href="article-embed.html">

<polymer-element name="drive-blog" attributes="blogTitle articlesFolderStr aboutFileId articlesMainFolderId GASbackendUrl socials">

  <template>
    <style>
      :host {
        position: absolute;
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        top: 0px;
        left: 0px;
        font-family: 'RobotoDraft', sans-serif;
      }
      #core_icon_button {
        left: 1490px;
        top: 600px;
      }
      #core_drawer_panel {
        position: absolute;
        top: 570px;
        right: 0px;
        bottom: 0px;
        left: 1480px;
      }
      #core_scaffold {
        position: absolute;
        top: 0px;
        right: 0px;
        bottom: 0px;
        left: 0px;
        width: 100%;
        height: 100%;
      }
      #core_header_panel {
        background-color: rgb(255, 255, 255);
      }
      #core_toolbar {
        color: rgb(255, 255, 255);
        background-color: #259b24;
      }
      core-scaffold::shadow core-toolbar{
        background-color: #42bd41;
      }
      #core_menu {
        font-size: 16px;
      }
      #core_submenu {
        left: -140px;
        top: 140px;
        position: absolute;
      }
      #core_animated_pages {
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgb(238, 238, 238);
      }
      core-item {
        white-space:normal;
        margin-bottom: 0.3em;
        margin-top: 0.3em;
      }
    </style>
    <!--Routing element-->
    <flatiron-director route="{{route}}" autoAsh
                        on-director-route="{{routeChanged}}"></flatiron-director>
    <!--element to performe Ajax calls to the backend-->
    <core-ajax id="core_ajax"
      auto="false"
      url="{{GASbackendUrl}}"
      params='{"action":"getBlogPosts", "folderId":"FOLDER_ID"}'
      method="POST"
      handleAs="json"
      on-core-response="{{handleResponse}}">
    </core-ajax>
    <!--App Structure-->
    <core-scaffold id="core_scaffold" mode="seamed" responsiveWidth="800px">
      <core-header-panel id="core_header_panel" navigation flex>
        <core-toolbar id="core_toolbar">
          {{blogTitle}}
        </core-toolbar>
        <!--Articles Groups/Folders -->
        <core-menu selected="{{selectedMenu}}" valueattr="label" theme="core-light-theme" on-core-select="{{selectAction}}">
          <template repeat="{{folders, i in articlesFolders}}">
            <core-submenu id="{{folders.folderId}}" icon="list" label="{{folders.title}} - {{folders.articlesCount}}">
              <!-- articles of the current folder-->
              <template repeat="{{article in articles | filterByFolder(folders.folderId) | sortByKey('date',true)}}">
                <core-item id="{{article.id}}"
                           label="{{article.title}}"
                           active?="{{route == article.id}}"
                           class="{{ {'core-selected' : route == article.id} | tokenList }} ">
                  <a href="#{{article.id}}"></a>
                </core-item>
              </template>
            </core-submenu>
          </template>
          <core-item id="{{aboutFileId}}" label="About" horizontal center layout icon="info-outline" active>
            <a href="#{{aboutFileId}}"></a>
          </core-item>
          <!--Display the link to the Main Folder for articles only if provided-->
          <template if="{{articlesMainFolderId.length>0}}">
            <core-item id="articleFolders_submenu" icon="folder-shared" label="Articles - Drive Folder" >
              <a href="https://drive.google.com/folderview?id={{articlesMainFolderId}}" target="_blank"></a>
            </core-item>
          </template>
          <core-submenu id="socials_submenu" icon="account-circle" label="All My Socials">
            <template repeat="{{social in socials}}">
              <core-item label="{{social.name}}" horizontal center layout>
                <a href="{{social.url}}" target="_blank"></a>
              </core-item>
            </template>
          </core-submenu>
        </core-menu>
      </core-header-panel>
      <div id="title" tool>{{articleTitle}}</div>
      <div id="contentDiv" layout horizontal center center-justified fit>
        <core-animated-pages valueAttr='id' selected="{{route}}" notap id="core_animated_pages" transitions="slide-from-right" on-core-select="{{selectPage}}">
          <template repeat="{{article in articles | sortByKey('date',false)}}">
            <section id="{{article.id}}" title="{{article.title}}">
              <paper-shadow z="2"></paper-shadow>
              <article-embed flex layout horizontal center center-justified
                           articleFileId="{{article.id}}"
                           ></article-embed>
            </section>
          </template>
        </core-animated-pages>
      </div>
    </core-scaffold>
  </template>

  <script>
    PolymerExpressions.prototype.sortByKey = function(array, key, desc) {
      return array.sort(function(a, b) {
        var x = a[key];
        var y = b[key];

        if (typeof x == "string"){
          x = x.toLowerCase();
          y = y.toLowerCase();
        }
        if(desc){
          return ((x < y) ? 1 : ((x > y) ? -1 : 0));
        }else{
          return ((x < y) ? -1 : ((x > y) ? 1 : 0));
        }
      });
    };

    Polymer({
      blogTitle: 'Blog Title',
      articlesFolders: [],
      articlesFolderStr:'',
      articles:[],
      aboutFileId: '',
      articlesMainFolderId:'',
      articleTitle: '',
      GASbackendUrl: '',
      /**/
      socials:[],
      loadArticles:function(folderId){
        var ajax = this.$.core_ajax;
        ajax.params='{"action":"getBlogPosts", "folderId":"'+folderId+'"}';
        ajax.go();//Execute the call
      },
      ready: function(){
        //if the About field is present, set the default route
        if(this.aboutFileId.length>0){
          //Push the about article to the article array
          this.articles.push({
            id:this.aboutFileId,
            title:'About',
            folderId:'',
            date:'2013-01-01'
          });
          //Set the default selected menu only if the routing is empty
          if (!this.route){
            this.selectedMenu='About';
          }
        }
        if (this.GASbackendUrl.length>0){
          //Parse the article Folders String
          this.articlesFolders = JSON.parse(this.articlesFolderStr);
          var element = this;
          //Load Articles with AJAX from the backend
          this.articlesFolders.forEach(function(item){
            //Add the Article Count Variable
            item.articlesCount = 0;
            element.loadArticles(item.folderId);
          });
        }
      },
      handleResponse: function(response){
        if (response.detail.response.length>0){
          //Add the result array to the list of articles available
          this.articles = this.articles.concat(response.detail.response);
          //Update the Articles Count of the proper Folder
          var folderId = response.detail.response[0].folderId;
          this.articlesFolders.some(function(item){
            if(item.folderId == folderId){
              item.articlesCount=response.detail.response.length;
              return true;
            }
            return false;
          });
        }
      },
      filterByFolder: function(articles,folderId){
        var toRet=[];
        //Filter the list of articles for folderID
        articles.forEach(function(item){
          if(item.folderId == folderId){
            toRet.push(item);
          }
        });

        return toRet;
      },
      selectAction: function(e, detail) {
        if (detail.isSelected) {
          var selectedItem = detail.item.id;
          //Change the route if the selected Item is a page
          var isPage=false;
          this.articles.some(function(item){

            if (item.id==selectedItem){
              isPage=true;
              return true;
            }

            return false;
          });

          if (isPage){
            //change the route
            this.route=selectedItem;
          }
        }
      },
      selectPage: function(e, detail) {
        if (detail.isSelected) {
          //Set the article Title
          this.articleTitle= detail.item.title;
        }
      }
    });

  </script>

</polymer-element>